<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
<title>Nova Eternity ‚Äî Mobile Optimized</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #020204;
  --c-1: #6a00ff;
  --c-2: #00ffc8;
  --nova-grad: linear-gradient(135deg, var(--c-1), var(--c-2));
  --font-main: 'Outfit', sans-serif;
}

* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent; 
}

body {
  margin: 0;
  background: var(--bg-dark);
  color: #fff;
  font-family: var(--font-main);
  height: 100vh;
  height: 100dvh;
  display: flex;
  overflow: hidden;
  position: relative;
  touch-action: pan-x pan-y;
}

.galaxy-bg {
  position: absolute;
  inset: -50%;
  background: conic-gradient(from 0deg at 50% 50%, #000 0deg, #1f003a 120deg, #6a00ff 180deg, #001f19 240deg, #000 360deg);
  filter: blur(70px);
  opacity: 0.6;
  animation: spinGalaxy 70s linear infinite;
  z-index: 0;
  pointer-events: none;
}

@keyframes spinGalaxy { 
  from { transform: rotate(0deg); } 
  to { transform: rotate(360deg); } 
}

.particles { 
  position: absolute; 
  inset: 0; 
  pointer-events: none; 
  z-index: 1; 
}

.star { 
  position: absolute; 
  background: white; 
  border-radius: 50%; 
  animation: twinkle 4s infinite ease-in-out; 
}

@keyframes twinkle { 
  0%, 100% { opacity: 0.2; transform: scale(0.8); } 
  50% { opacity: 1; transform: scale(1.2); } 
}

/* SIDEBAR */
.sidebar {
  width: 280px;
  background: rgba(12, 12, 18, 0.85);
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  display: flex;
  flex-direction: column;
  border-right: 1px solid rgba(255,255,255,0.1);
  transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  z-index: 200;
  padding: 24px 16px;
  padding-top: calc(24px + env(safe-area-inset-top));
}

.new-chat-btn {
  background: rgba(255,255,255,0.05);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 16px;
  padding: 14px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: 0.4s;
  margin-bottom: 24px;
  position: relative;
  overflow: hidden;
}

.new-chat-btn::before { 
  content:''; 
  position: absolute; 
  inset:0; 
  background: var(--nova-grad); 
  opacity: 0; 
  transition: 0.4s; 
}

.new-chat-btn:active::before { opacity: 0.2; }

.history-list { 
  flex: 1; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 8px;
  scrollbar-width: thin;
  scrollbar-color: rgba(255,255,255,0.2) transparent;
}

.history-list::-webkit-scrollbar {
  width: 4px;
}

.history-list::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
}

.h-item {
  padding: 12px 14px;
  border-radius: 12px;
  font-size: 14px;
  color: #aaa;
  cursor: pointer;
  transition: 0.3s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.h-item:active { 
  background: rgba(255,255,255,0.05); 
  color: #fff; 
}

.h-item.active { 
  background: rgba(106, 0, 255, 0.2); 
  color: #fff; 
  border: 1px solid rgba(106, 0, 255, 0.4); 
}

.sidebar-footer { 
  margin-top: auto; 
  padding-top: 16px; 
  border-top: 1px solid rgba(255,255,255,0.1); 
  display: flex; 
  gap: 8px; 
  padding-bottom: env(safe-area-inset-bottom); 
}

.icon-btn { 
  background: transparent; 
  border: 1px solid transparent; 
  color: #aaa; 
  cursor: pointer; 
  padding: 10px; 
  border-radius: 10px; 
  transition: 0.3s; 
}

/* MAIN */
.main { 
  flex: 1; 
  display: flex; 
  flex-direction: column; 
  position: relative; 
  width: 100%; 
  z-index: 10; 
}

.mobile-header {
  display: none;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  background: rgba(12, 12, 18, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  height: calc(60px + env(safe-area-inset-top));
  padding-top: env(safe-area-inset-top);
}

.brand {
  font-weight: 800;
  font-size: 22px;
  letter-spacing: -1px;
  background: var(--nova-grad);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: glowText 3s infinite alternate;
}

@keyframes glowText { 
  from { filter: drop-shadow(0 0 0px var(--c-1)); } 
  to { filter: drop-shadow(0 0 10px var(--c-2)); } 
}

.hamburger { 
  background: transparent; 
  border: none; 
  cursor: pointer; 
  padding: 8px; 
  width: 32px;
  height: 32px;
  display: flex; 
  flex-direction: column; 
  gap: 5px;
  justify-content: center;
  align-items: center;
}

.hamburger span { 
  width: 20px; 
  height: 2px; 
  background: #fff; 
  border-radius: 2px;
  transition: 0.3s;
}

/* CHAT */
.chat-scroll {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 30px 20px 140px 20px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
  height: 100%;
  position: relative;
}

.msg-group {
  display: flex;
  gap: 12px;
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
  opacity: 0;
  animation: popUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes popUp { 
  from { opacity: 0; transform: translateY(30px) scale(0.9); } 
  to { opacity: 1; transform: translateY(0) scale(1); } 
}

.msg-group.user { flex-direction: row-reverse; }

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  font-weight: 700;
  transition: 0.3s;
}

.avatar.ai { 
  background: rgba(255,255,255,0.05); 
  border: 1px solid rgba(255,255,255,0.1); 
  color: #fff; 
}

.avatar.ai svg { 
  width: 18px; 
  height: 18px; 
  fill: url(#gradIcon); 
}

.avatar.user { 
  background: var(--nova-grad); 
  color: #fff; 
}

.avatar.user svg { 
  width: 18px; 
  height: 18px; 
  fill: #fff; 
}

.bubble { 
  font-size: 15px; 
  line-height: 1.6; 
  color: #eee; 
  overflow-wrap: break-word;
  word-wrap: break-word;
  word-break: break-word;
  max-width: 100%;
}

.user .bubble {
  background: #1a1a20;
  padding: 12px 18px;
  border-radius: 20px;
  border-bottom-right-radius: 4px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 5px 25px rgba(0,0,0,0.2);
}

.bot .bubble { 
  background: transparent; 
  padding: 6px 0; 
  width: 100%; 
}

.generated-image, .user-upload-img {
  max-width: 100%;
  width: 100%;
  height: auto;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.1);
  margin-top: 10px;
  display: block;
  animation: fadeInImg 1s ease forwards;
}

@keyframes fadeInImg { 
  from { opacity: 0; transform: scale(0.95); } 
  to { opacity: 1; transform: scale(1); } 
}

.preview-container {
  padding: 10px 20px 0 20px;
  display: none;
  width: 100%;
  max-width: 800px;
  animation: slideUp 0.3s ease;
  position: absolute;
  bottom: calc(75px + env(safe-area-inset-bottom));
  left: 50%;
  transform: translateX(-50%);
  z-index: 50;
}

@keyframes slideUp { 
  from { transform: translate(-50%, 20px); opacity: 0; } 
  to { transform: translate(-50%, 0); opacity: 1; } 
}

.preview-box {
  background: rgba(40,40,50,0.95);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 10px;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  max-width: 100%;
}

.preview-thumb { 
  width: 40px; 
  height: 40px; 
  object-fit: cover; 
  border-radius: 6px;
  flex-shrink: 0;
}

.preview-close { 
  background: none; 
  border: none; 
  color: #ff5555; 
  cursor: pointer; 
  font-weight: bold; 
  padding: 5px;
  font-size: 18px;
  flex-shrink: 0;
}

.image-container {
  position: relative;
  margin-top: 15px;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.1);
  background: rgba(255,255,255,0.02);
  min-height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.img-loading-overlay {
  position: absolute;
  inset: 0;
  background: rgba(20, 20, 25, 0.8);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2;
}

.scanner-line {
  width: 100%;
  height: 2px;
  background: var(--nova-grad);
  box-shadow: 0 0 10px var(--c-1);
  position: absolute;
  top: 0;
  animation: scanDown 2s ease-in-out infinite;
}

@keyframes scanDown { 
  0% { top: 0%; opacity: 0; } 
  50% { opacity: 1; } 
  100% { top: 100%; opacity: 0; } 
}

.liquid-loader { 
  display: flex; 
  gap: 6px; 
  padding: 10px 0; 
}

.drop { 
  width: 10px; 
  height: 10px; 
  background: var(--c-1); 
  border-radius: 50%; 
  animation: jump 1s infinite ease-in-out; 
}

.drop:nth-child(2) { 
  background: var(--c-2); 
  animation-delay: 0.15s; 
}

.drop:nth-child(3) { 
  background: #fff; 
  animation-delay: 0.3s; 
}

@keyframes jump { 
  0%, 100% { transform: translateY(0); } 
  50% { transform: translateY(-10px); } 
}

.input-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 16px;
  padding-bottom: calc(16px + env(safe-area-inset-bottom));
  display: flex;
  justify-content: center;
  background: linear-gradient(to top, rgba(2,2,4,0.98) 60%, transparent);
  z-index: 60;
  transition: bottom 0.3s ease;
}

.input-wrapper {
  width: 100%;
  max-width: 800px;
  position: relative;
  background: rgba(25, 25, 30, 0.95);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 24px;
  padding: 6px 6px 6px 16px;
  display: flex;
  align-items: flex-end;
  gap: 8px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  transition: 0.3s;
}

.input-wrapper:focus-within {
  background: rgba(35, 35, 45, 0.98);
  border-color: rgba(106, 0, 255, 0.5);
  box-shadow: 0 20px 80px rgba(0,0,0,0.6);
  transform: translateY(-2px);
}

textarea {
  flex: 1;
  background: transparent;
  border: none;
  color: #fff;
  font-size: 16px;
  font-family: var(--font-main);
  resize: none;
  max-height: 150px;
  outline: none;
  height: 44px;
  padding: 12px 0;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

textarea::-webkit-scrollbar {
  display: none;
}

.attach-btn {
  width: 40px;
  height: 44px;
  background: transparent;
  border: none;
  cursor: pointer;
  color: #aaa;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.3s;
  flex-shrink: 0;
}

.attach-btn:active { 
  color: #fff; 
  transform: scale(0.95); 
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #fff;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: 0.3s;
}

.send-btn:active { 
  transform: scale(0.95); 
  background: var(--nova-grad); 
}

.send-btn svg { 
  width: 20px; 
  height: 20px; 
  fill: #000; 
  transition: 0.3s; 
}

.send-btn:active svg { 
  fill: #fff; 
}

.overlay { 
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,0.8); 
  opacity: 0; 
  pointer-events: none; 
  transition: 0.4s; 
  z-index: 150; 
  backdrop-filter: blur(10px); 
}

.overlay.active { 
  opacity: 1; 
  pointer-events: auto; 
}

.empty-state { 
  position: absolute; 
  top: 45%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  text-align: center; 
  width: 100%; 
  pointer-events: none;
  padding: 0 20px;
}

.empty-logo { 
  font-size: 48px; 
  font-weight: 800; 
  letter-spacing: -2px; 
  margin-bottom: 12px; 
  background: var(--nova-grad); 
  -webkit-background-clip: text; 
  -webkit-text-fill-color: transparent; 
}

.empty-sub { 
  font-size: 15px; 
  color: #777; 
}

/* MOBILE OPTIMIZATION */
@media (max-width: 768px) {
  body {
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
  }
  
  .sidebar { 
    position: fixed; 
    left: 0; 
    top: 0; 
    bottom: 0; 
    transform: translateX(-105%); 
    width: 280px;
    height: 100vh;
    height: 100dvh;
  }
  
  .sidebar.open { 
    transform: translateX(0); 
  }
  
  .mobile-header { 
    display: flex; 
  }
  
  .chat-scroll {
    padding-top: calc(60px + env(safe-area-inset-top) + 20px);
    padding-bottom: calc(90px + env(safe-area-inset-bottom));
    height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .input-container { 
    padding: 12px; 
    padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(2,2,4,0.98) 70%, transparent);
    z-index: 60;
  }
  
  .msg-group {
    gap: 10px;
  }
  
  .avatar {
    width: 32px;
    height: 32px;
  }
  
  .bubble {
    font-size: 14px;
  }
  
  .user .bubble {
    padding: 10px 16px;
  }
  
  .empty-logo {
    font-size: 40px;
  }
  
  .empty-sub {
    font-size: 14px;
  }
  
  /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
  .keyboard-open .input-container {
    position: fixed;
  }
  
  .keyboard-open .chat-scroll {
    padding-bottom: calc(120px + env(safe-area-inset-bottom));
  }
}

@media (max-width: 380px) {
  .input-wrapper {
    padding: 5px 5px 5px 12px;
    gap: 6px;
  }
  
  .attach-btn {
    width: 36px;
  }
  
  .send-btn {
    width: 40px;
    height: 40px;
  }
  
  textarea {
    font-size: 15px;
    height: 40px;
    padding: 10px 0;
  }
  
  .brand {
    font-size: 20px;
  }
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
.mobile-fix {
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  -webkit-text-size-adjust: 100%;
}

/* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ iOS */
textarea, input {
  font-size: 16px !important;
}
</style>
</head>
<body class="mobile-fix">

<div class="galaxy-bg"></div>
<div class="particles" id="particles"></div>
<div class="overlay" id="overlay"></div>

<aside class="sidebar" id="sidebar">
  <div class="new-chat-btn" id="btn-new"><span>+</span> <span>New Chat</span></div>
  <div class="history-list" id="history"></div>
  <div class="sidebar-footer">
    <button class="icon-btn" id="btn-clear" title="Clear">üóëÔ∏è</button>
    <div style="flex:1"></div>
    <div style="font-size:11px; color:#666; align-self:center;">NOVA ETERNITY</div>
  </div>
</aside>

<main class="main">
  <header class="mobile-header">
    <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
    <div class="brand">NOVA</div>
    <div style="width:32px"></div>
  </header>
  
  <div class="chat-scroll" id="messages">
    <div class="empty-state" id="welcome-msg">
      <div class="empty-logo">NOVA</div>
      <div class="empty-sub">100% Free AI & Image Generation</div>
    </div>
  </div>
  
  <div class="preview-container" id="preview-cont">
    <div class="preview-box">
      <img src="" id="img-preview" class="preview-thumb">
      <span style="font-size:12px; color:#aaa;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ</span>
      <button class="preview-close" id="btn-remove-img">‚úï</button>
    </div>
  </div>
  
  <div class="input-container">
    <div class="input-wrapper">
      <input type="file" id="img-upload" accept="image/*" style="display:none">
      <button class="attach-btn" id="btn-attach" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
      </button>
      <textarea id="input" placeholder="–°–ø—Ä–æ—Å–∏ –∏–ª–∏ –æ–ø–∏—à–∏, —á—Ç–æ —Å–æ–∑–¥–∞—Ç—å..." rows="1"></textarea>
      <button class="send-btn" id="btn-send"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
    </div>
  </div>
</main>

<svg width="0" height="0" style="position:absolute"><defs><linearGradient id="gradIcon" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#6a00ff" /><stop offset="100%" style="stop-color:#00ffc8" /></linearGradient></defs></svg>

<script>
// --- PARTICLES ---
const pContainer = document.getElementById('particles');
for(let i=0; i<30; i++) {
  const star = document.createElement('div');
  star.className = 'star';
  const size = Math.random() * 3 + 1;
  star.style.width = size + 'px';
  star.style.height = size + 'px';
  star.style.left = Math.random() * 100 + '%';
  star.style.top = Math.random() * 100 + '%';
  star.style.animationDuration = (Math.random() * 3 + 2) + 's';
  star.style.animationDelay = Math.random() * 5 + 's';
  pContainer.appendChild(star);
}

const el = {
  msgs: document.getElementById('messages'),
  input: document.getElementById('input'),
  btnSend: document.getElementById('btn-send'),
  btnAttach: document.getElementById('btn-attach'),
  imgUpload: document.getElementById('img-upload'),
  previewCont: document.getElementById('preview-cont'),
  imgPreview: document.getElementById('img-preview'),
  btnRemoveImg: document.getElementById('btn-remove-img'),
  btnNew: document.getElementById('btn-new'),
  btnClear: document.getElementById('btn-clear'),
  hamburger: document.getElementById('hamburger'),
  sidebar: document.getElementById('sidebar'),
  overlay: document.getElementById('overlay'),
  history: document.getElementById('history'),
  welcome: document.getElementById('welcome-msg')
};

let state = { chats: [], current: -1 };
let currentImageBase64 = null;
let isKeyboardOpen = false;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
function detectKeyboard() {
  const originalHeight = window.innerHeight;
  
  window.addEventListener('resize', function() {
    const newHeight = window.innerHeight;
    const diff = originalHeight - newHeight;
    
    if (diff > 100) {
      // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞
      isKeyboardOpen = true;
      document.body.classList.add('keyboard-open');
      setTimeout(scrollToBottom, 300);
    } else {
      // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∞
      isKeyboardOpen = false;
      document.body.classList.remove('keyboard-open');
    }
  });
}

el.btnAttach.onclick = () => el.imgUpload.click();

el.imgUpload.onchange = function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onloadend = function() {
      currentImageBase64 = reader.result;
      el.imgPreview.src = currentImageBase64;
      el.previewCont.style.display = 'block';
    }
    reader.readAsDataURL(file);
  }
};

el.btnRemoveImg.onclick = () => {
  currentImageBase64 = null;
  el.imgUpload.value = '';
  el.previewCont.style.display = 'none';
};

function toggleMenu() {
  const isOpen = el.sidebar.classList.contains('open');
  el.sidebar.classList.toggle('open', !isOpen);
  el.overlay.classList.toggle('active', !isOpen);
}

el.hamburger.onclick = toggleMenu;
el.overlay.onclick = toggleMenu;

function save() { 
  localStorage.setItem('nova_eternity_v3', JSON.stringify(state)); 
}

function load() {
  const d = localStorage.getItem('nova_eternity_v3');
  if(d) { 
    try { 
      state = JSON.parse(d); 
    } catch(e){ 
      state = {chats:[], current:-1}; 
    }
    renderHistory();
    renderChat();
  }
}

function renderHistory() {
  el.history.innerHTML = '';
  state.chats.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = `h-item ${i === state.current ? 'active' : ''}`;
    div.textContent = c.name || 'Chat';
    div.onclick = () => {
      state.current = i;
      renderHistory();
      renderChat();
      if(window.innerWidth<=768) toggleMenu();
    };
    el.history.appendChild(div);
  });
}

function renderChat() {
  el.msgs.innerHTML = '';
  if(state.current < 0 || !state.chats[state.current] || state.chats[state.current].messages.length === 0) {
    el.msgs.appendChild(el.welcome);
    el.welcome.style.display = 'block';
    return;
  }
  el.welcome.style.display = 'none';
  state.chats[state.current].messages.forEach(m => createMsgNode(m.role, m.text, m.image));
  scrollToBottom();
}

function createMsgNode(role, text, imageSrc) {
  const isUser = role === 'user';
  const group = document.createElement('div');
  group.className = `msg-group ${isUser ? 'user' : 'bot'}`;
  
  const ava = document.createElement('div');
  ava.className = `avatar ${isUser ? 'user' : 'ai'}`;
  
  if(isUser) 
    ava.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  else 
    ava.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/></svg>`;
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  
  if (imageSrc && isUser) {
    const usrImg = document.createElement('img');
    usrImg.src = imageSrc;
    usrImg.className = 'user-upload-img';
    bubble.appendChild(usrImg);
    if(text) {
      const caption = document.createElement('div');
      caption.style.marginTop = '8px';
      caption.innerHTML = formatText(text);
      bubble.appendChild(caption);
    }
  }
  else if (text.startsWith('!IMG:')) {
    const prompt = text.replace('!IMG:', '').trim();
    const encoded = encodeURIComponent(prompt + ", masterpiece, best quality, 8k, photorealistic");
    const randomSeed = Math.floor(Math.random() * 999999);
    const imgUrl = `https://image.pollinations.ai/prompt/${encoded}?nologo=true&seed=${randomSeed}`;
    
    const imgId = 'gen-' + randomSeed;
    const loaderId = 'load-' + randomSeed;
    
    bubble.innerHTML = `
      <div>–°–æ–∑–¥–∞—é (Pollinations Render): <b>${prompt.split(',')[0]}...</b></div>
      <div class="image-container">
        <div class="img-loading-overlay" id="${loaderId}">
          <div class="scanner-line"></div>
          <div class="loading-text">–†–µ–Ω–¥–µ—Ä–∏–Ω–≥...</div>
        </div>
        <img src="${imgUrl}" id="${imgId}" class="generated-image" alt="Art" />
      </div>`;
    
    setTimeout(() => {
      const iEl = document.getElementById(imgId);
      const lEl = document.getElementById(loaderId);
      if(iEl && lEl) {
        iEl.onload = () => { 
          lEl.style.display='none'; 
          iEl.classList.add('loaded'); 
          scrollToBottom(); 
        };
        iEl.onerror = () => { 
          lEl.innerHTML = '<div style="color:red">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–º–ø—Ç.</div>'; 
        };
      }
    }, 100);
  } else {
    bubble.innerHTML = formatText(text);
  }
  
  group.appendChild(ava);
  group.appendChild(bubble);
  el.msgs.appendChild(group);
}

function createLoader() {
  const loader = document.createElement('div');
  loader.id = 'temp-loader';
  loader.className = 'msg-group bot';
  loader.innerHTML = `
    <div class="avatar ai"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/></svg></div>
    <div class="bubble"><div class="liquid-loader"><div class="drop"></div><div class="drop"></div><div class="drop"></div></div></div>`;
  el.msgs.appendChild(loader);
  scrollToBottom();
}

function scrollToBottom() { 
  requestAnimationFrame(() => {
    el.msgs.scrollTop = el.msgs.scrollHeight; 
  });
}

function formatText(t) { 
  return (t || "").replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>'); 
}

async function send() {
  const txt = el.input.value.trim();
  const imgData = currentImageBase64;
  
  if(!txt && !imgData) return;
  
  if(state.current < 0) {
    state.chats.push({ name: txt ? txt.slice(0, 20) : "AI Chat", messages: [] });
    state.current = state.chats.length - 1;
    renderHistory();
  }
  
  state.chats[state.current].messages.push({ role: 'user', text: txt, image: imgData });
  el.input.value = '';
  el.input.style.height = '44px';
  currentImageBase64 = null;
  el.previewCont.style.display = 'none';
  el.imgUpload.value = '';
  
  renderChat();
  createLoader();
  
  try {
    let chatHistory = state.chats[state.current].messages.map(m => 
      `${m.role.toUpperCase()}: ${m.text || (m.image ? "User attached an image. " : "")}`
    ).join('\n');
    
    const systemPrompt = `You are a multilingual, creative AI. Analyze the user's last request and chat history. **ALWAYS respond in the language of the user's last message.**
1. IF the user asks to draw/generate an image (or modify an image by describing it, as you cannot see it): Create a single, highly aesthetic image prompt in English. Output ONLY: "!IMG: <your_prompt>"
2. OTHERWISE, provide a helpful and creative text answer in the user's language.`;

    const res = await fetch('https://text.pollinations.ai/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            messages: [
                { role: 'system', content: systemPrompt },
                ...state.chats[state.current].messages.map(m => ({
                    role: m.role,
                    content: m.text || (m.image ? "[Image attached]" : "")
                }))
            ],
            model: 'openai'
        })
    });

    if (!res.ok) throw new Error("Pollinations Server Error");
    
    const reply = await res.text();
    
    const loader = document.getElementById('temp-loader');
    if(loader) loader.remove();

    state.chats[state.current].messages.push({ role: 'assistant', text: reply });
    renderChat();
    save();
  } catch(e) {
    const loader = document.getElementById('temp-loader');
    if(loader) loader.remove();
    alert('AI System Error: ' + e.message + '. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
  }
}

el.btnSend.onclick = send;

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
el.input.addEventListener('focus', () => {
  if (window.innerWidth <= 768) {
    setTimeout(() => {
      scrollToBottom();
    }, 500); // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
  }
});

el.input.onkeydown = (e) => {
  if(e.key==='Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
};

el.input.oninput = function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
};

el.btnNew.onclick = () => {
  state.current = -1;
  renderHistory();
  renderChat();
  if(window.innerWidth <= 768) toggleMenu();
};

el.btnClear.onclick = () => {
  if(confirm('Delete all?')) {
    state.chats = [];
    state.current = -1;
    save();
    renderHistory();
    renderChat();
  }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
detectKeyboard();
load();
</script>
</body>
</html>